<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta property="og:title" content="Cat√°logo de Controles Remotos Russo Digital">
  <meta property="og:description" content="Eleg√≠ tu modelo, sum√° la cantidad y hac√© tu pedido f√°cil por WhatsApp. Venta mayorista en todo el pa√≠s.">
  <meta property="og:image" content="https://listamayorista.vercel.app/assets/og/og-image.webp">
  <meta property="og:image:width" content="500">
  <meta property="og:image:height" content="500">
  <meta name="description" content="Eleg√≠ tu modelo, sum√° la cantidad y hac√© tu pedido f√°cil por WhatsApp. Venta mayorista en todo el pa√≠s.">
  <title>Controles Remotos</title>
  <style>
    /* Reset */
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    :root{
      /* Marca */
      --brand:#0074E4;         /* Azul francia */
      --brand-600:#0056B3;     /* Hover / √©nfasis */
      --accent:#1E90FF;        /* Detalles */
      /* Estado / sem√°nticos */
      --danger:#e74c3c;
      --ink:#1f2937;           /* Texto principal */
      --muted:#6b7280;         /* Texto secundario */
      /* Superficies */
      --bg:#f6f8fb;            /* Gris muy claro */
      --card:#ffffff;
      /* Est√©tica */
      --shadow:0 6px 18px rgba(0,0,0,.06);
      --radius:14px;
    }

    body{ background:var(--bg); padding: 20px; color: var(--ink); }

    .header{
      text-align:center;
      margin-bottom: 18px;
    }

    .header h1{
      margin-bottom: 4px;
      letter-spacing:.2px;
      font-weight:800;
      color:var(--brand-600);
    }

    .subdata{
      font-size: 15px;
      color:#374151;
      line-height:1.4;
      margin-bottom: 8px;
      background-color: white;
    }

    .subtitle{
      font-size: 15px;
      color: var(--muted);
      line-height:1.5;
    }

    /* Top actions */
    .toolbar{
      position: sticky; top: 0; z-index: 30;
      background: rgba(255,255,255,.75);
      backdrop-filter: blur(6px);
      padding: 10px 12px 14px; margin-bottom: 10px; border-radius: var(--radius);
      border:1px solid rgba(0,0,0,.06);
    }
    .toolbar-inner{ max-width: 1100px; margin: 0 auto; display: grid; grid-template-columns: 1fr; gap: 10px; }
    @media (max-width: 720px){ .toolbar-inner{ grid-template-columns: 1fr; } }

    .select{
      padding: 10px 12px; border:1px solid #e5e7eb; border-radius: 12px; font-size: 16px; background:#fff; outline: none;
      transition: box-shadow .15s ease, border-color .15s ease;
    }
    .select:focus{ border-color: var(--brand); box-shadow: 0 0 0 3px rgba(0,116,228,.18); }

    /* CATEGOR√çAS (segmented) */
    .cats{
      margin:4px auto 0;display:flex;gap:8px;justify-content:center;flex-wrap:wrap;
      padding:0 12px;
    }
    .cat-btn{
      appearance:none;background:#fff;border:1px solid #e5e7eb;color:#111;
      padding:8px 14px;border-radius:999px;font-weight:700;cursor:pointer;
      transition: border-color .15s ease, background .15s ease, color .15s ease, transform .12s ease;
    }
    .cat-btn:hover{ border-color: var(--brand); transform: translateY(-1px); }
    .cat-btn.active{ background:var(--brand); color:#fff; border-color:transparent; }

    .offer-toggle{
      display:none; align-items:center; gap:10px; justify-content:center; padding-top: 2px;
    }
    .toggle{
      width: 46px; height: 24px; background:#cbd5e1; border-radius: 999px; position:relative; border:none; cursor:pointer;
      transition: background .15s ease;
    }
    .toggle::before{
      content:""; width: 20px; height: 20px; background:#fff; border-radius:50%; position:absolute; top:2px; left:2px; transition:.2s;
      box-shadow: var(--shadow);
    }
    .toggle.active{ background:#22c55e; }
    .toggle.active::before{ transform: translateX(22px); }

    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      background:#f1f5f9; border:1px solid #e2e8f0; border-bottom-width:2px; border-radius:6px;
      padding:2px 6px; font-size:12px; color:#64748b;
    }

    /* Grid */
    .grid{ max-width: 1100px; margin: 0 auto; display:grid; grid-template-columns: repeat(auto-fit, minmax(170px,1fr)); gap: 18px; }
    @media (max-width:480px){ .grid{ grid-template-columns: repeat(2,1fr); } }

    .card{
      background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow);
      padding: 22px 12px 12px; text-align:center; position:relative;
      display:flex; flex-direction:column; gap: 8px; min-height: 320px;
      transition: transform .15s ease, box-shadow .15s ease;
    }
    .card:hover{ transform: translateY(-3px); box-shadow: 0 10px 24px rgba(0,0,0,.08); }

    .image-wrap{
      height: 180px; overflow:hidden; border-radius: 12px; display:flex; align-items:center; justify-content:center; background: #f1f5f9;
      border:1px solid #eef2f7;
    }
    .card img{ width: 100%; height: 100%; object-fit: contain; transition: transform .25s ease; cursor: zoom-in; }
    .card img:hover{ transform: scale(1.06); }

    .price{ color:#374151; font-weight:800; }
    .regular-price{ text-decoration: line-through; color:#94a3b8; font-size: 14px; font-weight: 600; }
    .oferta-price{ color: var(--danger); font-weight: 900; font-size: 18px; margin-left: 6px; }

    .counter{ display:flex; justify-content:center; align-items:center; gap:8px; margin-top: 6px; }
    .counter button{ padding: 6px 10px; font-size:16px; cursor:pointer; background:#eef2f7; border:1px solid #e5e7eb; border-radius:10px; transition: background .15s ease, transform .1s ease; }
    .counter button:active{ transform: scale(.96); }
    .qty{ width: 52px; text-align:center; padding:6px 6px; border:1px solid #e5e7eb; border-radius:10px; }

    .add-btn{
      background: var(--brand); color:#fff; border:none; padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:800; letter-spacing:.2px;
      transition: background .15s ease, transform .1s ease, box-shadow .15s ease;
      box-shadow: 0 4px 10px rgba(0,116,228,.18);
    }
    .add-btn:hover{ background: var(--brand-600); }
    .add-btn:active{ transform: translateY(1px); }

    .oferta-label{
      background: var(--danger); color:#fff; font-size: 12px; font-weight: 800; padding: 4px 8px; border-radius: 0 0 10px 0; position:absolute; top:0; left:0;
    }

    /* ===== SIN STOCK (bloquea toda interacci√≥n y muestra r√≥tulo) ===== */
    .card.soldout { pointer-events:none; }
    .card.soldout .image-wrap img{ filter:grayscale(1); opacity:.35; }
    .card.soldout::before{
      content:""; position:absolute; inset:0; border-radius:var(--radius);
      background:rgba(255,255,255,.65);
    }
    .card.soldout::after{
      content:"SIN STOCK"; position:absolute; inset:0; display:grid; place-items:center;
      font-weight:900; letter-spacing:.06em; color:#475569; font-size:18px;
    }
    .card.soldout .add-btn{ background:#e5e7eb; color:#94a3b8; box-shadow:none; }

    /* Skeletons */
    .skeleton{ background: linear-gradient(90deg, #eef2f7 25%, #f8fafc 37%, #eef2f7 63%); background-size: 400% 100%; animation: shimmer 1.2s infinite; border-radius: 12px; }
    @keyframes shimmer{ 0%{background-position: 100% 0;} 100%{background-position: -100% 0;} }
    .card-skel{ padding: 16px; background: var(--card); box-shadow: var(--shadow); border-radius: var(--radius); display:grid; gap:10px; }
    .skel-img{ height: 180px; }
    .skel-line{ height: 14px; }
    .skel-btn{ height: 36px; border-radius: 12px; }

    /* Cart */
    .cart{ max-width: 1100px; margin: 50px auto 80px; padding: 20px; background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); border:1px solid #eef2f7; }
    .cart-title{ font-weight: 900; font-size: 18px; margin-bottom: 10px; color:var(--brand-600); }
    .cart-summary{ font-size: 14px; color:#334155; margin-top: 10px; }
    .cart-item{ margin-bottom: 14px; border-bottom:1px solid #eaeef5; padding: 10px 0 14px; position:relative; }
    .cart-thumb{ width: 44px; height: 44px; object-fit: contain; margin-right: 8px; vertical-align: middle; border-radius: 8px; background:#f1f5f9; border:1px solid #eef2f7; }
    .edit-controls{ display:flex; align-items:center; gap:8px; margin-top:6px; }
    .edit-controls button{ padding: 6px 10px; background:#eef2f7; border:1px solid #e5e7eb; cursor:pointer; font-size:14px; border-radius:10px; }
    .edit-controls input{ width: 50px; text-align:center; padding:6px 4px; border:1px solid #e5e7eb; border-radius:10px; }
    .delete-btn{ background:none; color: var(--danger); font-weight: 900; border:none; cursor:pointer; font-size: 20px; position:absolute; top: 6px; right: 0; padding: 5px; }
    .cart .cta{ display:flex; flex-wrap:wrap; gap:10px; margin-top: 14px; }
    .cart .cta button{ background:#27ae60; color:#fff; border:none; padding: 10px 16px; font-size: 16px; border-radius: 12px; cursor:pointer; font-weight:800; }
    .cart .cta button:hover{ background:#219150; }
    .cart .cta .clear{ background: var(--danger); }
    .cart .cta .clear:hover{ filter: brightness(.95); }

    /* Floating bar */
    #floatingCartBar{
      display: none;
      position: fixed; bottom: 0; left: 0; right: 0;
      background: var(--brand); color:#fff; padding: 10px 20px;
      justify-content: space-between; align-items:center; z-index: 1000; font-size: 16px;
      box-shadow: 0 -8px 18px rgba(0,0,0,.06);
    }
    #floatingCartBar button{ background:none; border:none; color:#fff; font-weight: 900; font-size: 16px; cursor:pointer; }

    /* Zoom modal */
    #zoomModal{ display:none; position:fixed; inset:0; background: rgba(0,0,0,.85); justify-content:center; align-items:center; flex-direction:column; z-index:2000; }
    #zoomModal img{ max-width: 90%; max-height: 80%; border-radius: 12px; }
    #zoomModal button{ margin-top:18px; background:#fff; color:#000; border:none; padding: 10px 16px; font-size:16px; border-radius: 12px; cursor:pointer; }
    #zoomModal button:hover{ background:#f3f4f6; }

    /* Scroll to top */
    #btnArriba{
      position: fixed; bottom: 80px; right: 20px; background: var(--brand); color:#fff; border:none; padding: 12px 16px;
      border-radius: 999px; font-size: 16px; cursor:pointer; z-index: 1001; display:none; box-shadow: 0 6px 16px rgba(0,0,0,.15);
    }
    #btnArriba:hover{ background: var(--brand-600); }

    /* Empty state */
    #mensajeVacio{ text-align:center; margin-top: 16px; font-size:15px; color:#94a3b8; display:none; }

    .container{ max-width: 1100px; margin: 0 auto; }
  </style>
</head>
<body>

  <div class="header">
    <h1>CONTROLES REMOTOS</h1>
    <p class="subdata">
      <strong>RUSSO Electr√≥nica</strong><br>
      Santiago 3462 - Rosario, Santa Fe
    </p>
    <p class="subtitle">
      üõí Eleg√≠ un modelo, con ‚ûï eleg√≠ la cantidad y presion√° ‚ÄúAgregar‚Äù.<br>
      Al terminar, üì≤ envi√° tu pedido por WhatsApp.
    </p>
  </div>

  <div class="toolbar">
    <div class="toolbar-inner">
      <!-- BOTONES DE CATEGOR√çA -->
      <div class="cats" id="catBar">
        <button class="cat-btn active" data-cat="lcd">LCD / SMART TV</button>
        <button class="cat-btn" data-cat="box">TV BOX</button>
        <button class="cat-btn" data-cat="universal">AIRE UNIVERSAL</button>
        <button class="cat-btn" data-cat="aire">AIRE ACOND.</button>
      </div>

      <!-- Bot√≥n de SOLO OFERTAS (oculto por ahora) -->
      <div class="offer-toggle">
        <button id="btnOferta" class="toggle" aria-pressed="false" aria-label="Ver solo ofertas"></button>
        <span>Solo ofertas</span>
        <span class="kbd" aria-hidden="true">Esc</span> <small class="muted">cierra zoom</small>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Skeletons while loading -->
    <div class="grid" id="productGrid">
      <div class="card-skel">
        <div class="skeleton skel-img"></div>
        <div class="skeleton skel-line" style="width: 80%"></div>
        <div class="skeleton skel-line" style="width: 60%"></div>
        <div class="skeleton skel-btn"></div>
      </div>
      <div class="card-skel">
        <div class="skeleton skel-img"></div>
        <div class="skeleton skel-line" style="width: 70%"></div>
        <div class="skeleton skel-line" style="width: 45%"></div>
        <div class="skeleton skel-btn"></div>
      </div>
      <div class="card-skel">
        <div class="skeleton skel-img"></div>
        <div class="skeleton skel-line" style="width: 90%"></div>
        <div class="skeleton skel-line" style="width: 55%"></div>
        <div class="skeleton skel-btn"></div>
      </div>
    </div>
    <p id="mensajeVacio">No hay resultados para los filtros aplicados.</p>
  </div>

  <div class="cart container" id="cart" aria-live="polite">
    <div class="cart-title">PEDIDO</div>
    <div class="cart-summary" id="cartSummary"></div>
    <p><strong>Cantidad total:</strong> <span id="itemCount">0</span></p>
    <p><strong>Total:</strong> <span id="totalPrice">$0</span></p>
    <div class="cta">
      <button onclick="sendOrder()">Enviar pedido por WhatsApp</button>
      <button class="clear" onclick="vaciarCarrito()">üóëÔ∏è Vaciar carrito</button>
    </div>
  </div>

  <div id="floatingCartBar" role="region" aria-label="Resumen de carrito">
    <button onclick="scrollToCart()">üßæ Ver pedido</button>
    <span id="floatingTotal">TOTAL: $0</span>
  </div>

  <div id="zoomModal" aria-modal="true" role="dialog">
    <img id="zoomImg" src="" alt="Vista ampliada">
    <button onclick="cerrarZoom()">‚úñ Cerrar (Esc)</button>
  </div>

  <div id="toast" style="display:none; position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
    background-color: var(--brand); color: white; padding: 12px 20px; border-radius: 8px; font-size: 16px;
    box-shadow: 0 4px 6px rgba(0,0,0,.1); z-index: 9999; transition: opacity .3s ease; opacity:0;">
    ¬°Agregado al carrito!
  </div>

  <button id="btnArriba" onclick="scrollToTop()">‚¨ÜÔ∏è Subir</button>

  <script>
    // ========= Config =========
    const CSV_URL = "./data/products.csv"; // ruta relativa dentro de /Tienda5000
    const IMG_BASE = "./assets/img";
    const EXT = ".webp";

    // Normaliza categor√≠as del CSV a las carpetas reales
    function canonicalCategory(raw){
      const v = String(raw || "").trim().toLowerCase();
      if (!v) return "";
      if (["lcd","led","lcd / smart","lcd/smart","smart","tv"].includes(v)) return "lcd";
      if (["aire","aire acond.","aire acondicionado","ar","aire acondicionado "].includes(v)) return "aire";
      if (["box","tv box","tvbox","android box","tv box / deco","tv box / deco "].includes(v)) return "box";
      if (["universal","uni","aire universal"].includes(v)) return "universal";
      return v; // fallback
    }

    // ========= Datos / Estado =========
    const products = [];
    const cart = {};
    let lastLoadOk = true;

    // Estado de UI
    let currentCatKey = "lcd"; // categor√≠a activa por botones
    const ofertaState = { value: false };

    // ========= Elementos =========
    const productGrid = document.getElementById("productGrid");
    const itemCount = document.getElementById("itemCount");
    const totalPrice = document.getElementById("totalPrice");
    const cartSummary = document.getElementById("cartSummary");
    const floatingBar = document.getElementById("floatingCartBar");
    const floatingTotal = document.getElementById("floatingTotal");
    const toast = document.getElementById("toast");
    const mensajeVacio = document.getElementById("mensajeVacio");
    const btnOferta = document.getElementById("btnOferta");
    const catBar = document.getElementById("catBar");

    // ========= Utilidades =========
    const fmt = new Intl.NumberFormat('es-AR', { style:'currency', currency:'ARS', maximumFractionDigits:0 });
    const price = (n) => fmt.format(Number.isFinite(n) ? n : 0);

    function savePrefs(){
      localStorage.setItem("mvp_prefs", JSON.stringify({
        cat: currentCatKey,
        oferta: ofertaState.value
      }));
    }
    function loadPrefs(){
      try{
        const p = JSON.parse(localStorage.getItem("mvp_prefs")||"{}");
        if(p.cat) currentCatKey = p.cat;
        if(typeof p.oferta === "boolean"){
          ofertaState.value = p.oferta;
          btnOferta.classList.toggle("active", p.oferta);
          btnOferta.setAttribute("aria-pressed", String(p.oferta));
        }
        setActiveCatButton();
      }catch(e){}
    }

    function showToast(msg){
      toast.textContent = msg;
      toast.style.display = "block";
      requestAnimationFrame(()=>{ toast.style.opacity = "1"; });
      setTimeout(()=>{
        toast.style.opacity = "0";
        setTimeout(()=>{ toast.style.display = "none"; }, 280);
      }, 1800);
    }

    function ensureImg(el){
      el.loading = "lazy";
      el.decoding = "async";
      el.onerror = () => { el.onerror=null; el.src = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(`
        <svg xmlns='http://www.w3.org/2000/svg' width='400' height='300'>
          <rect width='100%' height='100%' fill='#fafafa'/>
          <text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='#bbb' font-family='Arial' font-size='16'>Imagen no disponible</text>
        </svg>`); };
    }

    // Construye el display name seg√∫n categor√≠a
    function displayNameFor(p){
      const cat = p.category;
      if (cat === "lcd") return `LCD ${p.name}`;
      if (cat === "aire") return `AR ${p.name}`;
      return String(p.name);
    }

    // Construye la ruta local a la imagen
    function imgSrcFor(p){
      return `${IMG_BASE}/${p.category}/${p.name}${EXT}`;
    }

    // ========= Carrito =========
    const savedCart = localStorage.getItem("carritoControles");
    if (savedCart) { Object.assign(cart, JSON.parse(savedCart)); }

    function updateCart(){
      let totalItems = 0, totalCost = 0;
      cartSummary.innerHTML = "";
      for (const key in cart) {
        const item = cart[key];
        const subtotal = item.qty * item.price;
        totalItems += item.qty; totalCost += subtotal;

        const itemDiv = document.createElement("div");
        itemDiv.className = "cart-item";
        itemDiv.innerHTML = `
          <img src="${item.img}" class="cart-thumb" alt="${item.name}">
          <strong>${displayNameFor(item)}</strong> | ${price(item.price)} c/u | x${item.qty} | Total: ${price(subtotal)}
          <div class="edit-controls">
            <button aria-label="Quitar 1" onclick="editQty('${key.replaceAll("'","\\'")}', -1)">-</button>
            <input type="number" min="1" value="${item.qty}" onchange="setQty('${key.replaceAll("'","\\'")}', this.value)">
            <button aria-label="Sumar 1" onclick="editQty('${key.replaceAll("'","\\'")}', 1)">+</button>
          </div>
          <button class="delete-btn" title="Eliminar" onclick="deleteProduct('${key.replaceAll("'","\\'")}')">√ó</button>
        `;
        cartSummary.appendChild(itemDiv);
      }
      itemCount.textContent = totalItems;
      totalPrice.textContent = price(totalCost);
      floatingBar.style.display = totalItems > 0 ? "flex" : "none";
      floatingTotal.textContent = `TOTAL: ${price(totalCost)}`;
      localStorage.setItem("carritoControles", JSON.stringify(cart));
      if (Object.keys(cart).length === 0) localStorage.removeItem("carritoControles");
    }

    function addToCart(id, qty){
      const product = products.find(p=>p.id===id);
      if(!product) return;
      if(!product.inStock){
        showToast(`"${displayNameFor(product)}" est√° sin stock`);
        return;
      }
      const finalUnit = product.precioOferta || product.price;
      const key = product.name; // clave por name
      if (cart[key]) {
        cart[key].qty += qty;
      } else {
        cart[key] = { ...product, price: finalUnit, qty, img: imgSrcFor(product) };
      }
      updateCart();
      showToast(`${qty} unidad${qty>1?'es':''} de "${displayNameFor(product)}" agregada${qty>1?'s':''}`);
    }

    function editQty(name, delta){
      if(!cart[name]) return;
      cart[name].qty += delta;
      if(cart[name].qty < 1) cart[name].qty = 1;
      updateCart();
      const q = cart[name].qty;
      showToast(delta>0 ? `Sumaste 1 unidad de "${name}" (total: ${q})` : `Quitaste 1 unidad de "${name}" (total: ${q})`);
    }

    function setQty(name, newQty){
      const q = parseInt(newQty,10);
      if(cart[name] && q>0){
        cart[name].qty = q;
        updateCart();
        showToast(`Modificaste la cantidad de "${name}" a ${q} unidad${q>1?'es':''}`);
      }
    }

    function deleteProduct(name){
      if(confirm(`¬øQuer√©s eliminar "${name}" del carrito?`)){
        delete cart[name];
        updateCart();
      }
    }

    function vaciarCarrito(){
      if(confirm("¬øEst√°s seguro de que quer√©s vaciar el carrito?")){
        for(const k in cart) delete cart[k];
        localStorage.removeItem("carritoControles");
        updateCart();
      }
    }

    function scrollToCart(){ document.getElementById("cart").scrollIntoView({behavior:"smooth"}); }
    function scrollToTop(){ window.scrollTo({ top: 0, behavior: "smooth" }); }

    // ========= Productos / Filtros =========
    function setActiveCatButton(){
      catBar.querySelectorAll('.cat-btn').forEach(b=>{
        b.classList.toggle('active', b.dataset.cat === currentCatKey);
      });
    }

    function renderProductos(filtered){
      productGrid.innerHTML = "";
      let found = false;

      filtered.forEach(product=>{
        const card = document.createElement("div");
        card.className = "card" + (product.inStock ? "" : " soldout");
        card.setAttribute("aria-disabled", product.inStock ? "false" : "true");
        card.innerHTML = `
          ${product.oferta ? `<div class="oferta-label">OFERTA</div>` : ""}
          <div class="image-wrap">
            <img src="${imgSrcFor(product)}" alt="${displayNameFor(product)}" onclick="abrirZoom('${imgSrcFor(product)}')" />
          </div>
          <h3>${displayNameFor(product)}</h3>
          ${product.precioOferta ? `
            <p class="price">
              <span class="oferta-price">${price(product.precioOferta)}</span>
              <span class="regular-price">${price(product.price)}</span>
            </p>
          ` : `<p class="price">${price(product.price)}</p>`}
          <div class="counter">
            <button class="btn-minus" aria-label="Quitar">-</button>
            <input type="number" min="1" value="1" class="qty" />
            <button class="btn-plus" aria-label="Sumar">+</button>
          </div>
          <button class="add-btn" ${product.inStock ? "" : "disabled"}>Agregar</button>
        `;
        const img = card.querySelector("img"); ensureImg(img);

        const inputQty = card.querySelector(".qty");
        const btnMinus = card.querySelector(".btn-minus");
        const btnPlus = card.querySelector(".btn-plus");
        const addBtn = card.querySelector(".add-btn");

        btnMinus.onclick = ()=>{ const v = Math.max(1, parseInt(inputQty.value||"1",10)-1); inputQty.value = v; };
        btnPlus.onclick  = ()=>{ inputQty.value = (parseInt(inputQty.value||"1",10)+1); };
        addBtn.onclick   = ()=>{ const q = Math.max(1, parseInt(inputQty.value||"1",10)); addToCart(product.id, q); inputQty.value = 1; };

        productGrid.appendChild(card);
        found = true;
      });

      mensajeVacio.style.display = found ? "none" : "block";
    }

    function filtrarProductos(){
      const soloOferta = ofertaState.value;

      const filtered = products.filter(p=>{
        const catMatch = !currentCatKey || p.category === currentCatKey;
        const offerMatch = !soloOferta || p.oferta;
        return catMatch && offerMatch;
      });

      renderProductos(filtered);
      savePrefs();
    }

    // ========= Zoom =========
    function abrirZoom(src){
      document.getElementById("zoomImg").src = src;
      document.getElementById("zoomModal").style.display = "flex";
    }
    function cerrarZoom(){ document.getElementById("zoomModal").style.display = "none"; }

    window.addEventListener("keydown", (e)=>{
      if(e.key === "Escape"){ cerrarZoom(); }
    });

    // ========= CSV Parser (sin librer√≠as) =========
    function parseCSV(text){
      const rows = [];
      let cur = "", inQuotes = false, row = [];
      for (let i=0; i<text.length; i++){
        const ch = text[i], next = text[i+1];
        if (inQuotes){
          if (ch === '"' && next === '"'){ cur += '"'; i++; }
          else if (ch === '"'){ inQuotes = false; }
          else { cur += ch; }
        } else {
          if (ch === '"'){ inQuotes = true; }
          else if (ch === ','){ row.push(cur); cur = ""; }
          else if (ch === '\n' || ch === '\r'){
            if (cur !== "" || row.length){ row.push(cur); rows.push(row); row = []; cur=""; }
            if (ch === '\r' && next === '\n') i++; // CRLF
          } else { cur += ch; }
        }
      }
      if (cur !== "" || row.length) row.push(cur), rows.push(row);
      return rows;
    }

    function rowsToObjects(rows){
      if (!rows.length) return [];
      const headers = rows[0].map(h=> String(h||"").trim());
      const out = [];
      for (let r=1; r<rows.length; r++){
        const obj = {};
        const cols = rows[r];
        for (let c=0; c<headers.length; c++){
          obj[headers[c]] = (cols[c] ?? "").toString();
        }
        out.push(obj);
      }
      return out;
    }

    // Helpers para stock
    function parseStock(raw){
      if(raw == null) return null;
      const s = String(raw).trim().toLowerCase();
      if(s === "") return null;
      if(["no","sin","agotado","false","off","n","x"].includes(s)) return 0;
      const n = Number(s);
      return Number.isFinite(n) ? n : null;
    }

    // ========= Carga de CSV =========
    async function cargarProductos(){
      try{
        const res = await fetch(CSV_URL, { cache: "no-store" });
        if(!res.ok) throw new Error("Error de red");
        const text = await res.text();

        const rows = rowsToObjects(parseCSV(text));

        products.length = 0;

        rows.forEach((p, i) => {
          const oferta = String(p.oferta || "").trim().toLowerCase();
          const isOffer = ["si","s√≠","yes","true","1"].includes(oferta);
          const priceNum = Number(p.price);
          const ofertaNum = Number(p.precio_oferta);
          const cat = canonicalCategory(p.category);

          // lee stock desde varias posibles columnas: stock, qty, cantidad, existencia
          const stockRaw = p.stock ?? p.qty ?? p.cantidad ?? p.existencia;
          const stockVal = parseStock(stockRaw);
          const inStock = stockVal === null ? true : stockVal > 0;

          const prod = {
            id: i+1,
            name: (p.name || "").toString().trim(),
            price: Number.isFinite(priceNum) ? priceNum : 0,
            oferta: isOffer,
            precioOferta: isOffer && Number.isFinite(ofertaNum) ? ofertaNum : null,
            category: cat,
            inStock
          };
          products.push(prod);
        });

        filtrarProductos();
        lastLoadOk = true;
      } catch(err){
        if(lastLoadOk){
          const warn = document.createElement("p");
          warn.style.cssText = "text-align:center;color:#b00;margin:8px 0 14px;";
          warn.textContent = "No se pudo cargar ./data/products.csv. Verific√° el archivo y rutas de im√°genes.";
          productGrid.parentElement.insertBefore(warn, productGrid);
        }
        lastLoadOk = false;
      }
    }

    // ========= Eventos UI =========
    btnOferta.addEventListener("click", ()=>{
      ofertaState.value = !ofertaState.value;
      btnOferta.classList.toggle("active", ofertaState.value);
      btnOferta.setAttribute("aria-pressed", String(ofertaState.value));
      filtrarProductos();
    });

    catBar.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-cat]');
      if (!btn) return;
      const k = btn.dataset.cat;
      if (k === currentCatKey) return;
      currentCatKey = k;
      setActiveCatButton();
      filtrarProductos();
    });

    window.addEventListener("scroll", ()=>{
      const btn = document.getElementById("btnArriba");
      btn.style.display = window.scrollY > 300 ? "block" : "none";
    });

    // ========= Pedido por WhatsApp (versi√≥n sin emojis) =========
    function sendOrder(){
      if (Object.keys(cart).length === 0){ 
        alert("Tu carrito est√° vac√≠o."); 
        return; 
      }

      let message = "Hola, este es mi pedido desde la *Tienda Russo Digital*:\n\n";
      message += "*DETALLE DEL PEDIDO:*\n\n";

      for (const key in cart) {
        const item = cart[key];
        const subtotal = item.price * item.qty;
        message += `‚Ä¢ ${displayNameFor(item)} ‚Äî ${price(item.price)} √ó ${item.qty} = ${price(subtotal)}\n`;
      }

      const total = Object.values(cart).reduce((s,i)=> s + i.qty * i.price, 0);
      const qty = Object.values(cart).reduce((s,i)=> s + i.qty, 0);
      
      message += `\n*Cantidad total:* ${qty} unidades`;
      message += `\n*Total:* ${price(total)}`;

      const phone = "5493415851441"; // <-- tu n√∫mero de WhatsApp
      const url = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
      window.open(url, "_blank");
    }

    // ========= Exponer funciones al scope global =========
    window.abrirZoom = abrirZoom;
    window.cerrarZoom = cerrarZoom;
    window.scrollToCart = scrollToCart;
    window.scrollToTop = scrollToTop;
    window.deleteProduct = deleteProduct;
    window.editQty = editQty;
    window.setQty = setQty;
    window.vaciarCarrito = vaciarCarrito;
    window.sendOrder = sendOrder;

    // ========= Init =========
    loadPrefs();
    updateCart();
    setActiveCatButton();
    cargarProductos();
    // setInterval(cargarProductos, 30000);
  </script>
</body>
</html>
